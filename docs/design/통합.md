## Exec (ê¸°ë³¸ì•ˆ: ì‚¬ì´ë“œë°” ë©€í‹°ë·° í†µí•© í”„ë¡œí† íƒ€ì…)

* í˜„í–‰ **GanttGenerator/GanttPreview**(íŒŒì¼ ì—…ë¡œë“œâ†’ìŠ¤ì¼€ì¤„ ìƒì„±â†’ë¯¸ë¦¬ë³´ê¸°)ë¥¼ ê·¸ëŒ€ë¡œ â€œSchedule ë·°â€ë¡œ ìœ ì§€í•˜ê³ , ìƒë‹¨ì— **Voyage Selector**/ì „ì—­ ìƒíƒœë¥¼ ë‘ì–´ **Documents ë·°**ì™€ 1:1ë¡œ ì—°ë™í•©ë‹ˆë‹¤.
* ì •ì  HTMLì˜ ê°•ì (ë¬¸ì„œ íŒ¨í‚¤ì§€Â·D-4/â‰¥24hÂ·2â€“3 business daysÂ·Tide ì°¸ì¡°)ì„ **DocRule JSON**ë¡œ í‘œì¤€í™”í•˜ê³ , ìŠ¤ì¼€ì¤„ ë§ˆì¼ìŠ¤í†¤ì—ì„œ **Due Date ìë™ ê³„ì‚°**í•˜ë„ë¡ ìœ í‹¸ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
* êµ¬í˜„ì€ Next.js(App Router) êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ë©°, `zod + date-fns`(ì´ë¯¸ ìŠ¤íƒì— ì¡´ì¬)ë¡œ ìŠ¤í‚¤ë§ˆ ê²€ì¦/ë‚ ì§œ ì—°ì‚°ì„ ê³ ì •í•©ë‹ˆë‹¤.
* ì„±ëŠ¥ì€ â€œwaterfall ì œê±°/ë²ˆë“¤ ìµœì†Œí™”/ë¶ˆí•„ìš” re-render ì–µì œâ€ ì›ì¹™ìœ¼ë¡œ, Gantt ê°™ì€ ë¬´ê±°ìš´ ë·°ëŠ” `dynamic import`/memoizationìœ¼ë¡œ ê²©ë¦¬í•©ë‹ˆë‹¤.

---

## Visual (ì»´í¬ë„ŒíŠ¸ ë¶„í•´ë„: ì‚¬ì´ë“œë°” ë©€í‹°ë·°)

```mermaid
graph TD
  AppPage["app/(dashboard)/page.tsx"] --> Provider["DashboardProvider (Context)"]
  Provider --> Shell["AppShell"]
  Shell --> Sidebar["SidebarNav"]
  Shell --> Topbar["Topbar (VoyageSelector + Global Filters)"]
  Shell --> Main["Main View Outlet"]

  Main --> ScheduleView["ScheduleView"]
  Main --> DocumentsView["DocumentsView"]
  Main --> OperationsView["OperationsView (ë³‘ë ¬/SPMT)"]
  Main --> TideWeatherView["TideWeatherView"]

  ScheduleView --> GanttGen["GanttGenerator (ê¸°ì¡´)"]
  GanttGen --> GanttPrev["GanttPreview (ê¸°ì¡´)"]

  DocumentsView --> DocKPIs["DocKpiCards"]
  DocumentsView --> DocChecklist["DocumentChecklist"]
  DocumentsView --> DocTimeline["DeadlineLadder (ì˜µì…˜: Gantt Overlay)"]

  Provider --> DeriveVoyages["deriveVoyagesFromScheduleData()"]
  Provider --> DueCalc["calcDocDueDates()"]
```

---

## Options (A/B/C)

| Option | êµ¬ì¡°                                        | ì¥ì                      | ë¦¬ìŠ¤í¬                | Time |
| ------ | ----------------------------------------- | ---------------------- | ------------------ | ---- |
| A      | **Context Provider + íŒŒìƒê³„ì‚°(useMemo)** (ê¶Œì¥) | ìµœì†Œ ì¹¨ìŠµ, ë¹ ë¥¸ í†µí•©, íƒ€ì…/ê²€ì¦ ê³ ì • | ìƒíƒœ ì»¤ì§€ë©´ Provider ë¹„ëŒ€ | 1â€“2ì¼ |
| B      | Zustand ìŠ¤í† ì–´                               | ë·°/íƒ­ ì¦ê°€ì— ìœ ë¦¬, ì„ íƒ/í•„í„° ì•ˆì •   | ì˜ì¡´ì„±/íŒ¨í„´ ì¶”ê°€, ëŸ¬ë‹ì»¤ë¸Œ    | 2â€“3ì¼ |
| C      | ì„œë²„ ì €ì¥(í”„ë¡œì íŠ¸/ìƒíƒœ ì˜ì†)                         | íŒ€ ê³µìœ /ê°ì‚¬ë¡œê·¸, íˆìŠ¤í† ë¦¬        | API/DB ì„¤ê³„ í•„ìš”       | 1â€“2ì£¼ |

---

## Roadmap (Prepareâ†’Pilotâ†’Buildâ†’Operateâ†’Scale)

1. **Prepare (ë°˜ì¼)**

* DocRule(JSON) ì´ˆì•ˆ ë°˜ì˜: PTW 13 + Loading 4 + NOC 6 + í•µì‹¬ ìš´ì˜ ë£°(D-4/â‰¥24h/2â€“3 business days)
* ë§ˆì¼ìŠ¤í†¤ ë§¤í•‘ ê·œì¹™(ì´ë¦„/íŒ¨í„´) ê²°ì •(ê°€ì • ê¸°ë°˜, ë¯¸ìŠ¤ë§¤ì¹˜ ëŒ€ë¹„)

2. **Pilot (1ì¼)**

* AppShell + Sidebar + DocumentsView(ì½ê¸° ì „ìš©)
* ì¼ì • ì—…ë¡œë“œ/ê³ ì •ë°ì´í„° í† ê¸€ ì‹œ DocumentsView KPI ìë™ ê°±ì‹ 

3. **Build (1â€“2ì¼)**

* ë¬¸ì„œ ì²´í¬(ìƒíƒœ) ë¡œì»¬ ì €ì¥(LocalStorage) + Export/Import(JSON)
* DeadlineLadder(ì˜¤ë²„ë ˆì´) 1ì°¨(ì„ íƒ)

4. **Operate (ì´í›„)**

* ë‹´ë‹¹ì/ì¦ë¹™ ë§í¬/ëŒ“ê¸€, ìœ„í—˜ ì•Œë¦¼(Overdue/At Risk)
* ë¬¸ì„œ ìƒíƒœ ë³€ê²½ Audit Trail(ê°„ë‹¨ ë¡œê·¸)

5. **Scale**

* ë‹¤ì¤‘ í”„ë¡œì íŠ¸ ì €ì¥/ê³µìœ (ì„œë²„), ê¶Œí•œ/RBAC(ì˜µì…˜)

---

## (Auto/QA) ìµœì†Œ ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

* [ ] ì¼ì • ë³€ê²½(ë˜ëŠ” ì—…ë¡œë“œ) ì‹œ **Due Date ì¬ê³„ì‚°**ì´ ì¦‰ì‹œ ë°˜ì˜ë˜ëŠ”ê°€
* [ ] ë§ˆì¼ìŠ¤í†¤ ëˆ„ë½ ì‹œ **Fail-safe(â€œâ€”â€ + ì›ì¸ í‘œì‹œ)** ë˜ëŠ”ê°€
* [ ] DocumentsView ë Œë”ê°€ Gantt ìŠ¤í¬ë¡¤/ì¤Œê³¼ ë…ë¦½ì ìœ¼ë¡œ ë™ì‘(ë¶ˆí•„ìš” re-render ì–µì œ)

---

## Acc (ê°€ì •)

* ê°€ì •: `ScheduleTask.name` ë˜ëŠ” `activityName`ì— â€œMZP Arrival/Load-out/MZP Departure/AGI Arrivalâ€ì„ ì‹ë³„ ê°€ëŠ¥í•œ ë¬¸ìì—´ë¡œ í¬í•¨(ì—†ìœ¼ë©´ matcher í…Œì´ë¸”ë¡œ ë³´ì™„).
* ê°€ì •: ë¬¸ì„œ ìƒíƒœëŠ” ì´ˆê¸°ì—” ì‚¬ìš©ì ë¡œì»¬(ë¸Œë¼ìš°ì €) ì €ì¥ìœ¼ë¡œ ì¶©ë¶„(íŒ€ ê³µìœ ëŠ” Phase 2).

---

# í”„ë¡œí† íƒ€ì… ì‚°ì¶œë¬¼ (ì»´í¬ë„ŒíŠ¸/JSON ìŠ¤í‚¤ë§ˆ/ë§ˆê° ê³„ì‚° ìœ í‹¸)

ì•„ë˜ëŠ” **ë°”ë¡œ ë¶™ì—¬ì„œ ì‹¤í–‰ ê°€ëŠ¥í•œ ìˆ˜ì¤€**ì˜ ìµœì†Œ íŒŒì¼ ì„¸íŠ¸ì…ë‹ˆë‹¤. (ê¸°ì¡´ êµ¬ì¡°/ìŠ¤íƒê³¼ ì •í•©: Next.js App Router, TS, zod, date-fns)

---

## 1) ì»´í¬ë„ŒíŠ¸ (ì‚¬ì´ë“œë°” ë©€í‹°ë·°)

### `components/app-shell.tsx`

```tsx
"use client";

import * as React from "react";
import { SidebarNav } from "./sidebar-nav";
import { Topbar } from "./topbar";

export type ViewKey = "schedule" | "documents" | "operations" | "tide-weather";

export function AppShell({
  view,
  onViewChange,
  children,
}: {
  view: ViewKey;
  onViewChange: (v: ViewKey) => void;
  children: React.ReactNode;
}) {
  return (
    <div className="h-screen w-full flex">
      <aside className="w-60 border-r border-border bg-card">
        <SidebarNav view={view} onViewChange={onViewChange} />
      </aside>

      <div className="flex-1 flex flex-col min-w-0">
        <header className="h-14 border-b border-border bg-background">
          <Topbar />
        </header>

        <main className="flex-1 min-h-0 overflow-hidden">{children}</main>
      </div>
    </div>
  );
}
```

### `components/sidebar-nav.tsx`

```tsx
"use client";

import { ViewKey } from "./app-shell";
import { Button } from "@/components/ui/button";

const items: Array<{ key: ViewKey; label: string }> = [
  { key: "schedule", label: "Schedule (Gantt)" },
  { key: "documents", label: "Documents" },
  { key: "operations", label: "Operations" },
  { key: "tide-weather", label: "Tide & Weather" },
];

export function SidebarNav({
  view,
  onViewChange,
}: {
  view: ViewKey;
  onViewChange: (v: ViewKey) => void;
}) {
  return (
    <nav className="p-3 space-y-2">
      <div className="text-xs font-semibold text-muted-foreground px-2 py-2">
        Control Tower
      </div>
      {items.map((it) => (
        <Button
          key={it.key}
          variant={view === it.key ? "default" : "ghost"}
          className="w-full justify-start"
          onClick={() => onViewChange(it.key)}
        >
          {it.label}
        </Button>
      ))}
    </nav>
  );
}
```

### `components/topbar.tsx` (Voyage ì„ íƒ/ì „ì—­ í•„í„°)

```tsx
"use client";

import * as React from "react";
import { useDashboard } from "@/lib/dashboard/dashboard-provider";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";

export function Topbar() {
  const { voyages, selectedVoyageId, setSelectedVoyageId } = useDashboard();

  return (
    <div className="h-full px-4 flex items-center gap-4">
      <div className="font-semibold text-sm">AGI TR Dashboard</div>

      <div className="flex-1" />

      <div className="w-[320px]">
        <Select value={selectedVoyageId ?? ""} onValueChange={(v) => setSelectedVoyageId(v)}>
          <SelectTrigger>
            <SelectValue placeholder="Voyage ì„ íƒ" />
          </SelectTrigger>
          <SelectContent>
            {voyages.map((v) => (
              <SelectItem key={v.id} value={v.id}>
                {v.label}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>
    </div>
  );
}
```

---

## 2) ì „ì—­ ìƒíƒœ(Provider) + ë·° ë¼ìš°íŒ…(í˜ì´ì§€)

### `lib/dashboard/dashboard-provider.tsx`

```tsx
"use client";

import * as React from "react";
import type { ScheduleData } from "@/lib/types"; // ê¸°ì¡´ íƒ€ì… ì‚¬ìš© :contentReference[oaicite:11]{index=11}
import { deriveVoyagesFromScheduleData } from "../voyage/derive-voyages";
import { loadDocRules } from "../documents/load-doc-rules";
import { calcDocDueDates } from "../documents/deadline-engine";
import type { DocStatusMap } from "../documents/types";

type DashboardState = {
  scheduleData: ScheduleData | null;
  setScheduleData: (d: ScheduleData | null) => void;

  voyages: Array<{ id: string; label: string; tripKey?: string }>;
  selectedVoyageId: string | null;
  setSelectedVoyageId: (id: string) => void;

  // ë¬¸ì„œ ìƒíƒœ(ì²´í¬/ë‹´ë‹¹ì/ì¦ë¹™) - ì´ˆê¸°ì—” ë¡œì»¬ ì €ì¥
  docStatus: DocStatusMap;
  setDocStatus: (m: DocStatusMap) => void;

  // ê³„ì‚° ê²°ê³¼(ì„ íƒ Voyage ê¸°ì¤€)
  computed: ReturnType<typeof calcDocDueDates> | null;
};

const Ctx = React.createContext<DashboardState | null>(null);

export function DashboardProvider({ children }: { children: React.ReactNode }) {
  const [scheduleData, setScheduleData] = React.useState<ScheduleData | null>(null);
  const [selectedVoyageId, setSelectedVoyageId] = React.useState<string | null>(null);
  const [docStatus, setDocStatus] = React.useState<DocStatusMap>({});

  const voyages = React.useMemo(() => {
    const vs = deriveVoyagesFromScheduleData(scheduleData);
    // ìµœì´ˆ ì„ íƒ ê¸°ë³¸ê°’
    if (!selectedVoyageId && vs.length > 0) setSelectedVoyageId(vs[0].id);
    return vs.map((v) => ({ id: v.id, label: v.label, tripKey: v.tripKey }));
  }, [scheduleData]); // eslint-disable-line react-hooks/exhaustive-deps

  const computed = React.useMemo(() => {
    if (!scheduleData || !selectedVoyageId) return null;
    const all = deriveVoyagesFromScheduleData(scheduleData);
    const v = all.find((x) => x.id === selectedVoyageId);
    if (!v) return null;

    const rules = loadDocRules();
    return calcDocDueDates({
      voyage: v,
      rules,
      statusMap: docStatus,
      now: new Date(),
    });
  }, [scheduleData, selectedVoyageId, docStatus]);

  const value: DashboardState = {
    scheduleData,
    setScheduleData,
    voyages,
    selectedVoyageId,
    setSelectedVoyageId,
    docStatus,
    setDocStatus,
    computed,
  };

  return <Ctx.Provider value={value}>{children}</Ctx.Provider>;
}

export function useDashboard() {
  const v = React.useContext(Ctx);
  if (!v) throw new Error("DashboardProvider missing");
  return v;
}
```

### `app/(dashboard)/page.tsx`

```tsx
"use client";

import * as React from "react";
import { AppShell, ViewKey } from "@/components/app-shell";
import { DashboardProvider, useDashboard } from "@/lib/dashboard/dashboard-provider";
import dynamic from "next/dynamic";

// ë¬´ê±°ìš´ ë·°ëŠ” dynamic importë¡œ ë¶„ë¦¬ (ë²ˆë“¤/ì´ˆê¸° ë¡œë“œ ìµœì í™”) :contentReference[oaicite:12]{index=12}
const ScheduleView = dynamic(() => import("@/components/views/schedule-view").then(m => m.ScheduleView), { ssr: false });
const DocumentsView = dynamic(() => import("@/components/views/documents-view").then(m => m.DocumentsView), { ssr: false });

function Inner() {
  const [view, setView] = React.useState<ViewKey>("schedule");
  const { computed } = useDashboard();

  return (
    <AppShell view={view} onViewChange={setView}>
      <div className="h-full w-full overflow-auto p-4">
        {view === "schedule" && <ScheduleView />}
        {view === "documents" && <DocumentsView computed={computed} />}
        {view === "operations" && <div>OperationsView (í”„ë¡œí† íƒ€ì…: ë‹¤ìŒ ë‹¨ê³„)</div>}
        {view === "tide-weather" && <div>TideWeatherView (í”„ë¡œí† íƒ€ì…: ë‹¤ìŒ ë‹¨ê³„)</div>}
      </div>
    </AppShell>
  );
}

export default function Page() {
  return (
    <DashboardProvider>
      <Inner />
    </DashboardProvider>
  );
}
```

### `components/views/schedule-view.tsx` (ê¸°ì¡´ GanttGenerator ì¬ì‚¬ìš©)

```tsx
"use client";

import * as React from "react";
import { useDashboard } from "@/lib/dashboard/dashboard-provider";
import { GanttGenerator } from "@/components/gantt-generator"; // ê¸°ì¡´ ì»´í¬ë„ŒíŠ¸ :contentReference[oaicite:13]{index=13}

/**
 * ìµœì†Œ ì¹¨ìŠµ í†µí•©:
 * - GanttGenerator ë‚´ë¶€ì—ì„œ scheduleDataë¥¼ ë§Œë“¤ê³  ìˆìœ¼ë¯€ë¡œ,
 *   onScheduleDataChange ì½œë°±ì„ ì¶”ê°€(íŒ¨ì¹˜)í•˜ë©´ Providerì— ì£¼ì… ê°€ëŠ¥.
 */
export function ScheduleView() {
  const { setScheduleData } = useDashboard();

  return (
    <div className="space-y-4">
      <div className="text-sm text-muted-foreground">
        ì¼ì • ì—…ë¡œë“œ/ìƒì„± ê²°ê³¼ê°€ Documents ë·°ì˜ Due Date ê³„ì‚°ì— ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.
      </div>

      <GanttGenerator
        // @ts-expect-error: í”„ë¡œí† íƒ€ì… íŒ¨ì¹˜(ì•„ë˜ì— ì¶”ê°€ ì•ˆë‚´)
        onScheduleDataChange={(d) => setScheduleData(d)}
      />
    </div>
  );
}
```

### `components/views/documents-view.tsx`

```tsx
"use client";

import * as React from "react";
import type { ReturnTypeOfCalc } from "@/lib/documents/types";
import { DocumentKpiCards } from "@/components/documents/document-kpi-cards";
import { DocumentChecklist } from "@/components/documents/document-checklist";

export function DocumentsView({ computed }: { computed: ReturnTypeOfCalc | null }) {
  if (!computed) {
    return <div className="text-sm text-muted-foreground">Schedule/Voyageë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.</div>;
  }

  return (
    <div className="space-y-4">
      <DocumentKpiCards computed={computed} />
      <DocumentChecklist computed={computed} />
    </div>
  );
}
```

---

## 3) JSON ìŠ¤í‚¤ë§ˆ (DocRule/Status/Voyage)

### `lib/documents/schemas.ts` (zod ê¸°ë°˜)

```ts
import { z } from "zod";

export const MilestoneKey = z.enum(["MZP_ARRIVAL", "LOAD_OUT", "MZP_DEPARTURE", "AGI_ARRIVAL"]);

export const DocRuleSchema = z.object({
  id: z.string(),
  title: z.string(),
  category: z.enum(["PTW_PACK", "LOADING_DOCS", "NOC", "OTHER"]),
  mandatory: z.boolean().default(true),

  // ë§ˆê° ê¸°ì¤€ì (Anchor)
  anchor: MilestoneKey,

  // D-4 ê°™ì€ ê·œì¹™(ìŒìˆ˜ë©´ ì´ì „)
  offsetDays: z.number().int(),

  // "2-3 business days" ê°™ì€ ì¼€ì´ìŠ¤
  businessDays: z.boolean().default(false),

  // ">=24h" ê°™ì€ ì‹œê°„ ê¸°ì¤€(ì—†ìœ¼ë©´ null)
  leadHours: z.number().int().nullable().default(null),

  tags: z.array(z.string()).default([]),
});

export const DocStatusSchema = z.object({
  ruleId: z.string(),
  state: z.enum(["NOT_STARTED", "IN_PROGRESS", "SUBMITTED", "APPROVED", "REJECTED"]).default("NOT_STARTED"),
  owner: z.string().nullable().default(null),
  submittedAt: z.string().datetime().nullable().default(null),
  evidenceUrl: z.string().url().nullable().default(null),
  remark: z.string().nullable().default(null),
});

export type DocRule = z.infer<typeof DocRuleSchema>;
export type DocStatus = z.infer<typeof DocStatusSchema>;
```

### `data/doc-rules.default.json` (ì •ì  HTMLì—ì„œ ì¶”ì¶œí•œ ì´ˆê¸° ë£°ì…‹)

* í•µì‹¬: **D-4 íŒ¨í‚¤ì§€ ì™„ë¹„**, **Land Permit 2â€“3 business days**, **Marine PTW â‰¥24h**, PTW Pack 13 items + Loading docs + NOC docs

```json
{
  "version": "0.1.0",
  "rules": [
    { "id": "PTW_RA", "title": "Risk Assessment", "category": "PTW_PACK", "mandatory": true, "anchor": "MZP_ARRIVAL", "offsetDays": -4, "businessDays": false, "leadHours": null, "tags": ["ADPort"] },
    { "id": "PTW_CONSENT", "title": "PTW applicant/receiver consent form", "category": "PTW_PACK", "mandatory": true, "anchor": "MZP_ARRIVAL", "offsetDays": -4, "businessDays": false, "leadHours": null, "tags": ["ADPort"] },
    { "id": "PTW_LAND_APP", "title": "PTW Application for Land oversized & heavy load", "category": "PTW_PACK", "mandatory": true, "anchor": "LOAD_OUT", "offsetDays": -3, "businessDays": true, "leadHours": null, "tags": ["LandPermit", "2-3 business days"] },
    { "id": "PTW_STOWAGE", "title": "Stowage Plan", "category": "PTW_PACK", "mandatory": true, "anchor": "LOAD_OUT", "offsetDays": -4, "businessDays": false, "leadHours": null, "tags": ["stowage"] },
    { "id": "PTW_MS", "title": "Method Statement (incl. weather criteria)", "category": "PTW_PACK", "mandatory": true, "anchor": "MZP_ARRIVAL", "offsetDays": -4, "businessDays": false, "leadHours": null, "tags": ["HSE", "weather"] },
    { "id": "PTW_COUNTDOWN", "title": "Countdown Plan", "category": "PTW_PACK", "mandatory": false, "anchor": "MZP_ARRIVAL", "offsetDays": -3, "businessDays": false, "leadHours": null, "tags": [] },
    { "id": "PTW_UNDERTAKING", "title": "Undertaking Letter", "category": "PTW_PACK", "mandatory": false, "anchor": "MZP_ARRIVAL", "offsetDays": -3, "businessDays": false, "leadHours": null, "tags": [] },
    { "id": "PTW_STABILITY", "title": "Stability Calculation", "category": "PTW_PACK", "mandatory": true, "anchor": "MZP_DEPARTURE", "offsetDays": -2, "businessDays": false, "leadHours": null, "tags": ["stability"] },
    { "id": "PTW_CERTS", "title": "3rd party equipment certificates (SPMT/operator)", "category": "PTW_PACK", "mandatory": false, "anchor": "LOAD_OUT", "offsetDays": -3, "businessDays": false, "leadHours": null, "tags": ["SPMT"] },
    { "id": "PTW_MWS", "title": "Marine Warranty Survey (Required before sailing)", "category": "PTW_PACK", "mandatory": true, "anchor": "MZP_DEPARTURE", "offsetDays": -1, "businessDays": false, "leadHours": 24, "tags": ["MWS", ">=24h"] },
    { "id": "PTW_MOORING", "title": "Mooring Plan", "category": "PTW_PACK", "mandatory": false, "anchor": "LOAD_OUT", "offsetDays": -2, "businessDays": false, "leadHours": null, "tags": ["mooring"] },
    { "id": "PTW_LASHING", "title": "Lashing Plan", "category": "PTW_PACK", "mandatory": true, "anchor": "LOAD_OUT", "offsetDays": -2, "businessDays": false, "leadHours": null, "tags": ["lashing"] },
    { "id": "PTW_TIDE", "title": "Tide table / tide window confirmation (Mina Zayed)", "category": "PTW_PACK", "mandatory": true, "anchor": "LOAD_OUT", "offsetDays": -2, "businessDays": false, "leadHours": null, "tags": ["tide"] },

    { "id": "LOAD_MANIFEST", "title": "Cargo list / manifest (per voyage)", "category": "LOADING_DOCS", "mandatory": false, "anchor": "LOAD_OUT", "offsetDays": -3, "businessDays": false, "leadHours": null, "tags": ["dims/weight/CoG"] },
    { "id": "LOAD_CIPL", "title": "Packing List / CI (if applicable)", "category": "LOADING_DOCS", "mandatory": false, "anchor": "LOAD_OUT", "offsetDays": -3, "businessDays": false, "leadHours": null, "tags": ["CIPL"] },
    { "id": "LOAD_PHOTOS", "title": "Cargo photos (current condition)", "category": "LOADING_DOCS", "mandatory": false, "anchor": "LOAD_OUT", "offsetDays": -2, "businessDays": false, "leadHours": null, "tags": ["photos"] },
    { "id": "LOAD_SEQUENCE", "title": "Load sequence / trailer allocation", "category": "LOADING_DOCS", "mandatory": false, "anchor": "LOAD_OUT", "offsetDays": -2, "businessDays": false, "leadHours": null, "tags": ["sequence"] },

    { "id": "NOC_TRADE", "title": "Local trading license", "category": "NOC", "mandatory": true, "anchor": "MZP_DEPARTURE", "offsetDays": -2, "businessDays": false, "leadHours": null, "tags": [] },
    { "id": "NOC_RA_ERP", "title": "Detailed risk assessment & emergency response plan", "category": "NOC", "mandatory": true, "anchor": "MZP_DEPARTURE", "offsetDays": -2, "businessDays": false, "leadHours": null, "tags": [] },
    { "id": "NOC_NOOBJ", "title": "No objection from relevant authorities", "category": "NOC", "mandatory": true, "anchor": "MZP_DEPARTURE", "offsetDays": -2, "businessDays": false, "leadHours": null, "tags": [] },
    { "id": "NOC_VOYAGEPLAN", "title": "Voyage plan (MZP â†’ AGI)", "category": "NOC", "mandatory": true, "anchor": "MZP_DEPARTURE", "offsetDays": -1, "businessDays": false, "leadHours": null, "tags": [] },
    { "id": "NOC_ROUTEMAP", "title": "Route map", "category": "NOC", "mandatory": false, "anchor": "MZP_DEPARTURE", "offsetDays": -1, "businessDays": false, "leadHours": null, "tags": [] },
    { "id": "NOC_AWARD", "title": "Contract award letter copy", "category": "NOC", "mandatory": false, "anchor": "MZP_DEPARTURE", "offsetDays": -1, "businessDays": false, "leadHours": null, "tags": [] }
  ]
}
```

---

## 4) ë§ˆê° ê³„ì‚° ìœ í‹¸ (Due Date Engine)

### `lib/documents/deadlines.ts`

```ts
import { addDays, isWeekend } from "date-fns";

export function addBusinessDaysSafe(date: Date, deltaDays: number) {
  // deltaDaysê°€ ìŒìˆ˜ë„ ê°€ëŠ¥
  let d = new Date(date);
  const step = deltaDays >= 0 ? 1 : -1;
  let remain = Math.abs(deltaDays);

  while (remain > 0) {
    d = addDays(d, step);
    if (!isWeekend(d)) remain -= 1;
  }
  return d;
}

export function applyOffset(date: Date, offsetDays: number, businessDays: boolean) {
  if (businessDays) return addBusinessDaysSafe(date, offsetDays);
  return addDays(date, offsetDays);
}

export type RiskTier = "ON_TRACK" | "AT_RISK" | "OVERDUE" | "UNKNOWN";

export function evalRisk(dueAt: Date | null, now: Date, atRiskHours = 48): RiskTier {
  if (!dueAt) return "UNKNOWN";
  const diffMs = dueAt.getTime() - now.getTime();
  const diffHours = diffMs / (1000 * 60 * 60);
  if (diffHours < 0) return "OVERDUE";
  if (diffHours <= atRiskHours) return "AT_RISK";
  return "ON_TRACK";
}
```

### `lib/documents/deadline-engine.ts`

```ts
import type { DocRule } from "./schemas";
import type { VoyageDerived, DocStatusMap, ReturnTypeOfCalc } from "./types";
import { applyOffset, evalRisk } from "./deadlines";

export function calcDocDueDates({
  voyage,
  rules,
  statusMap,
  now,
}: {
  voyage: VoyageDerived;
  rules: DocRule[];
  statusMap: DocStatusMap;
  now: Date;
}): ReturnTypeOfCalc {
  const items = rules.map((r) => {
    const anchorDate = voyage.milestones[r.anchor] ?? null;

    const dueBase = anchorDate ? applyOffset(anchorDate, r.offsetDays, r.businessDays) : null;

    // leadHours(>=24h) ê°™ì€ ì¡°ê±´ì€ â€œìµœì†Œ ì œì¶œ ë§ˆê°â€ìœ¼ë¡œ í•´ì„:
    // - ê¸°ì¤€ì¼ì´ ì¡´ì¬í•˜ë©´ dueBaseì—ì„œ leadHoursë¥¼ ì¶”ê°€ ì°¨ê°í•˜ëŠ” ë°©ì‹ë„ ê°€ëŠ¥
    // - í”„ë¡œí† íƒ€ì…ì—ì„  ë¦¬ìŠ¤í¬ íŒì •ì—ë§Œ ì‚¬ìš©(ì˜µì…˜)
    const dueAt = dueBase;

    const risk = evalRisk(dueAt, now, r.leadHours ?? 48);
    const status = statusMap[`${voyage.id}::${r.id}`] ?? { ruleId: r.id, state: "NOT_STARTED" };

    return {
      voyageId: voyage.id,
      rule: r,
      anchorDate,
      dueAt,
      risk,
      status,
    };
  });

  const totals = {
    total: items.length,
    overdue: items.filter((x) => x.risk === "OVERDUE").length,
    atRisk: items.filter((x) => x.risk === "AT_RISK").length,
    done: items.filter((x) => ["SUBMITTED", "APPROVED"].includes(x.status.state)).length,
  };

  return { voyage, items, totals };
}
```

### `lib/documents/load-doc-rules.ts`

```ts
import raw from "@/data/doc-rules.default.json";
import { DocRuleSchema } from "./schemas";

export function loadDocRules() {
  // zodë¡œ ê·œì¹™ì„ ê³ ì •(ë¨¸ì‹  íŒŒì‹±/íšŒê·€ ë°©ì§€)
  return raw.rules.map((r: any) => DocRuleSchema.parse(r));
}
```

### `lib/documents/types.ts`

```ts
import type { DocRule, DocStatus } from "./schemas";

export type DocStatusMap = Record<string, DocStatus>;

export type VoyageDerived = {
  id: string;
  label: string;
  tripKey?: string;
  milestones: Partial<Record<"MZP_ARRIVAL" | "LOAD_OUT" | "MZP_DEPARTURE" | "AGI_ARRIVAL", Date>>;
};

export type CalcItem = {
  voyageId: string;
  rule: DocRule;
  anchorDate: Date | null;
  dueAt: Date | null;
  risk: "ON_TRACK" | "AT_RISK" | "OVERDUE" | "UNKNOWN";
  status: DocStatus;
};

export type ReturnTypeOfCalc = {
  voyage: VoyageDerived;
  items: CalcItem[];
  totals: { total: number; overdue: number; atRisk: number; done: number };
};
```

---

## 5) Voyage ë§ˆì¼ìŠ¤í†¤ ì¶”ì¶œ(ìŠ¤ì¼€ì¤„ â†’ Voyage)

### `lib/voyage/derive-voyages.ts`

```ts
import type { ScheduleData, ScheduleTask } from "@/lib/types"; // ê¸°ì¡´ íƒ€ì… :contentReference[oaicite:15]{index=15}
import type { VoyageDerived } from "@/lib/documents/types";

function toDate(x: string | Date): Date {
  return x instanceof Date ? x : new Date(x);
}

function pickMilestone(tasks: ScheduleTask[], matcher: RegExp): Date | null {
  const hit = tasks.find((t) => matcher.test(String(t.name)));
  if (!hit) return null;
  return toDate(hit.startDate);
}

/**
 * í•µì‹¬: Activity ID (2)ê°€ Trip ê·¸ë£¹ í‚¤ë¼ëŠ” ì‹œìŠ¤í…œ ì •ì˜ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© :contentReference[oaicite:16]{index=16}
 */
export function deriveVoyagesFromScheduleData(scheduleData: ScheduleData | null): VoyageDerived[] {
  if (!scheduleData) return [];

  const byTrip = new Map<string, ScheduleTask[]>();
  for (const t of scheduleData.tasks ?? []) {
    const k = String((t as any).activityId2 ?? "UNKNOWN");
    byTrip.set(k, [...(byTrip.get(k) ?? []), t]);
  }

  const out: VoyageDerived[] = [];
  let idx = 1;

  for (const [tripKey, tasks] of byTrip.entries()) {
    // matcherëŠ” í”„ë¡œì íŠ¸ ë„¤ì´ë°ì— ë§ì¶° ì¡°ì •(í”„ë¡œí† íƒ€ì…: ê¸°ë³¸ íŒ¨í„´)
    const mzpArrival = pickMilestone(tasks, /MZP\s*Arrival|Arrives\s*to\s*MZP/i);
    const loadOut = pickMilestone(tasks, /Load-?out/i);
    const mzpDeparture = pickMilestone(tasks, /MZP\s*Departure|Sail-?away|Transit start/i);
    const agiArrival = pickMilestone(tasks, /AGI\s*Arrival|Arrives\s*to\s*AGI/i);

    out.push({
      id: `V${idx}`,
      label: `Voyage ${idx} (${tripKey})`,
      tripKey,
      milestones: {
        MZP_ARRIVAL: mzpArrival ?? undefined,
        LOAD_OUT: loadOut ?? undefined,
        MZP_DEPARTURE: mzpDeparture ?? undefined,
        AGI_ARRIVAL: agiArrival ?? undefined,
      },
    });

    idx += 1;
  }

  return out;
}
```

---

## 6) Documents UI (KPI + ì²´í¬ë¦¬ìŠ¤íŠ¸)

### `components/documents/document-kpi-cards.tsx`

```tsx
"use client";

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import type { ReturnTypeOfCalc } from "@/lib/documents/types";

export function DocumentKpiCards({ computed }: { computed: ReturnTypeOfCalc }) {
  const { totals } = computed;

  return (
    <div className="grid grid-cols-4 gap-3">
      <Card>
        <CardHeader><CardTitle className="text-xs">TOTAL</CardTitle></CardHeader>
        <CardContent className="text-2xl font-bold">{totals.total}</CardContent>
      </Card>
      <Card>
        <CardHeader><CardTitle className="text-xs">DONE</CardTitle></CardHeader>
        <CardContent className="text-2xl font-bold">{totals.done}</CardContent>
      </Card>
      <Card>
        <CardHeader><CardTitle className="text-xs">AT RISK</CardTitle></CardHeader>
        <CardContent className="text-2xl font-bold">{totals.atRisk}</CardContent>
      </Card>
      <Card>
        <CardHeader><CardTitle className="text-xs">OVERDUE</CardTitle></CardHeader>
        <CardContent className="text-2xl font-bold">{totals.overdue}</CardContent>
      </Card>
    </div>
  );
}
```

### `components/documents/document-checklist.tsx`

```tsx
"use client";

import * as React from "react";
import type { ReturnTypeOfCalc } from "@/lib/documents/types";
import { useDashboard } from "@/lib/dashboard/dashboard-provider";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Checkbox } from "@/components/ui/checkbox";

function keyOf(voyageId: string, ruleId: string) {
  return `${voyageId}::${ruleId}`;
}

export function DocumentChecklist({ computed }: { computed: ReturnTypeOfCalc }) {
  const { docStatus, setDocStatus } = useDashboard();

  const onToggleSubmitted = (ruleId: string, checked: boolean) => {
    const k = keyOf(computed.voyage.id, ruleId);
    const prev = docStatus[k] ?? { ruleId, state: "NOT_STARTED" as const };

    const next = {
      ...prev,
      state: checked ? "SUBMITTED" : "IN_PROGRESS",
      submittedAt: checked ? new Date().toISOString() : null,
    };

    setDocStatus({ ...docStatus, [k]: next });
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-sm">Document Checklist</CardTitle>
      </CardHeader>
      <CardContent className="space-y-2">
        {computed.items.map((it) => {
          const k = keyOf(it.voyageId, it.rule.id);
          const st = docStatus[k] ?? it.status;
          const isDone = st.state === "SUBMITTED" || st.state === "APPROVED";

          return (
            <div key={k} className="flex items-center gap-3 rounded-md border border-border p-2">
              <Checkbox checked={isDone} onCheckedChange={(v) => onToggleSubmitted(it.rule.id, Boolean(v))} />
              <div className="flex-1">
                <div className="text-sm font-medium">
                  {it.rule.title}
                  {it.rule.mandatory ? <span className="ml-2 text-xs text-destructive">Mandatory</span> : <span className="ml-2 text-xs text-muted-foreground">Optional</span>}
                </div>
                <div className="text-xs text-muted-foreground">
                  Anchor: {it.rule.anchor} | Offset: {it.rule.offsetDays} days
                  {it.rule.businessDays ? " (businessDays)" : ""} | Risk: {it.risk}
                </div>
              </div>
              <div className="text-xs text-muted-foreground min-w-[140px] text-right">
                Due: {it.dueAt ? it.dueAt.toISOString().slice(0, 10) : "â€”"}
              </div>
            </div>
          );
        })}
      </CardContent>
    </Card>
  );
}
```

---

# í•„ìˆ˜ íŒ¨ì¹˜ 1ê°œ (ê¸°ì¡´ GanttGeneratorì— ì½œë°± ì¶”ê°€)

í˜„í–‰ êµ¬ì¡°ì—ì„œ `GanttGenerator`ê°€ ìµœìƒìœ„ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ë¯€ë¡œ(ì—…ë¡œë“œ/ìƒì„±/ë¯¸ë¦¬ë³´ê¸°), ìƒì„± ê²°ê³¼ì˜ `scheduleData`ë¥¼ ì™¸ë¶€ë¡œ ë…¸ì¶œí•˜ëŠ” **ì½œë°± 1ê°œë§Œ ì¶”ê°€**í•˜ë©´ ë©ë‹ˆë‹¤.

### `components/gantt-generator.tsx` (ì¶”ê°€)

```tsx
// propsì— ì¶”ê°€
export function GanttGenerator({
  onScheduleDataChange,
}: {
  onScheduleDataChange?: (d: any) => void;
}) {
  // ... ê¸°ì¡´ ë¡œì§ì—ì„œ scheduleData set í•˜ëŠ” ì§€ì ì—
  // setScheduleData(newData);
  // ì•„ë˜ í•œ ì¤„ ì¶”ê°€:
  // onScheduleDataChange?.(newData);
}
```

---

## ğŸ”§ ì‹¤í–‰ ì»¤ë§¨ë“œ(ë¡œì»¬)

```bash
pnpm install
pnpm dev
```

---

## ZERO log

| ë‹¨ê³„    | ì´ìœ                                                           | ìœ„í—˜ | ìš”ì²­ë°ì´í„°                            | ë‹¤ìŒì¡°ì¹˜                             |
| ----- | ----------------------------------------------------------- | -- | -------------------------------- | -------------------------------- |
| í•´ë‹¹ ì—†ìŒ | ë³¸ ì‘ì—…ì€ ì‚¬ìš©ì ì œê³µ íŒŒì¼/êµ¬ì¡° ê¸°ë°˜ì˜ í”„ë¡œí† íƒ€ì… ì„¤ê³„ë¡œ, ê·œì •/ìš”ìœ¨/ì‹¤ì‹œê°„ ë°ì´í„° í™•ì •ì´ í•„ìš”í•˜ì§€ ì•ŠìŒ | ë‚®ìŒ | (ì„ íƒ) ì‹¤ì œ ìŠ¤ì¼€ì¤„ Task ëª…ëª… ê·œì¹™(ë§ˆì¼ìŠ¤í†¤ ë¬¸ìì—´) | ë§ˆì¼ìŠ¤í†¤ matcherë¥¼ í”„ë¡œì íŠ¸ ë„¤ì´ë°ì— ë§ê²Œ 1íšŒ íŠœë‹ |

---

ì›í•˜ì‹œë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ, **DeadlineLadder(ë¬¸ì„œ ë§ˆê° ì„¸ë¡œì„ ) ì˜¤ë²„ë ˆì´**ë¥¼ `GanttPreview`ì— â€œì˜µì…˜ ì»´í¬ë„ŒíŠ¸â€ë¡œ ë¶™ì´ëŠ” íŒ¨ì¹˜ê¹Œì§€ ë°”ë¡œ í™•ì¥í•˜ê² ìŠµë‹ˆë‹¤. (í˜„ì¬ `GanttPreview` êµ¬ì¡°/ìŠ¤í¬ë¡¤ ë™ê¸°í™” ê·œì¹™ì„ ì¡´ì¤‘í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì„¤ê³„)
